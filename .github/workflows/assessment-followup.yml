name: Assessment Follow-up Agent

on:
  # Run daily at 7 AM PST (3 PM UTC)
  schedule:
    - cron: '0 15 * * *'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      days_back:
        description: 'Days to look back for assessments'
        required: false
        default: '1'
        type: string

permissions:
  contents: write
  issues: write

jobs:
  process-assessments:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout infra repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'scripts/assessment-followup/package.json'

      - name: Install dependencies
        working-directory: scripts/assessment-followup
        run: npm install

      - name: Create output directories
        run: mkdir -p followup/drafts

      - name: Run Assessment Follow-up Agent
        working-directory: scripts/assessment-followup
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          DAYS_BACK: ${{ github.event.inputs.days_back || '1' }}
        run: node index.js

      - name: Check for new follow-ups
        id: check_followups
        run: |
          if [ -d "followup/drafts" ] && [ "$(ls -A followup/drafts 2>/dev/null)" ]; then
            echo "has_followups=true" >> $GITHUB_OUTPUT
            echo "count=$(ls followup/drafts/*.md 2>/dev/null | wc -l)" >> $GITHUB_OUTPUT
          else
            echo "has_followups=false" >> $GITHUB_OUTPUT
            echo "count=0" >> $GITHUB_OUTPUT
          fi

      - name: Commit follow-up drafts
        if: steps.check_followups.outputs.has_followups == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Assessment Follow-up Bot"
          git add followup/
          git diff --staged --quiet || git commit -m "ðŸ“§ Assessment follow-ups for $(date +%Y-%m-%d)

          Generated ${{ steps.check_followups.outputs.count }} follow-up drafts.

          ðŸ¤– Generated with Assessment Follow-up Agent"
          git push

      - name: Create review issue
        if: steps.check_followups.outputs.has_followups == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const count = '${{ steps.check_followups.outputs.count }}';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ“§ Assessment Follow-ups Ready - ${date}`,
              body: `## New Follow-up Drafts

            The Assessment Follow-up Agent has generated **${count}** personalized follow-up drafts.

            ### Location
            \`followup/drafts/\`

            ### Review Checklist
            - [ ] Review each follow-up email
            - [ ] Personalize as needed
            - [ ] Send via Gmail
            - [ ] Mark as sent in the files
            - [ ] Schedule demo calls if interested

            ### Quick Links
            - [View drafts directory](../../tree/main/followup/drafts)

            ---
            ðŸ¤– Generated by Assessment Follow-up Agent`,
              labels: ['follow-up', 'assessment']
            });
