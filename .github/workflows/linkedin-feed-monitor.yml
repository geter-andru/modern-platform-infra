name: LinkedIn Feed Monitor

on:
  # Run daily at 7 AM PST (3 PM UTC)
  schedule:
    - cron: '0 15 * * *'

  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  monitor-feed:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout infra repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'scripts/linkedin-feed-monitor/package.json'

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Install dependencies
        working-directory: scripts/linkedin-feed-monitor
        run: npm install

      - name: Create output directories
        run: mkdir -p feed-signals/daily

      - name: Run LinkedIn Feed Monitor
        working-directory: scripts/linkedin-feed-monitor
        env:
          LINKEDIN_SESSION_COOKIE: ${{ secrets.LINKEDIN_SESSION_COOKIE }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GOOGLE_SHEETS_ID: ${{ secrets.LEAD_GEN_SHEETS_ID }}
          GOOGLE_SERVICE_ACCOUNT: ${{ secrets.GOOGLE_SERVICE_ACCOUNT }}
          OUTPUT_ROOT: ${{ github.workspace }}
        run: node index.js

      - name: Check for signals
        id: check_signals
        run: |
          if [ -d "feed-signals/daily" ] && [ "$(ls -A feed-signals/daily 2>/dev/null)" ]; then
            echo "has_signals=true" >> $GITHUB_OUTPUT
            # Count high-intent signals
            high_intent=$(grep -l "priority.*high" feed-signals/daily/*.json 2>/dev/null | wc -l || echo "0")
            echo "high_intent_count=$high_intent" >> $GITHUB_OUTPUT
          else
            echo "has_signals=false" >> $GITHUB_OUTPUT
            echo "high_intent_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Commit signals
        if: steps.check_signals.outputs.has_signals == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Feed Monitor Bot"
          git add feed-signals/
          git diff --staged --quiet || git commit -m "ðŸ“¡ LinkedIn feed signals for $(date +%Y-%m-%d)

          ðŸ¤– Generated with LinkedIn Feed Monitor"
          git push

      - name: Create engagement issue
        if: steps.check_signals.outputs.high_intent_count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const date = new Date().toISOString().split('T')[0];
            const highIntent = '${{ steps.check_signals.outputs.high_intent_count }}';

            // Read today's signals
            let signalsSummary = '';
            try {
              const signalsDir = 'feed-signals/daily';
              const files = fs.readdirSync(signalsDir).filter(f => f.startsWith(date));

              for (const file of files.slice(0, 1)) {
                const content = JSON.parse(fs.readFileSync(`${signalsDir}/${file}`, 'utf8'));
                const highPriority = content.signals?.filter(s => s.priority === 'high') || [];

                for (const signal of highPriority.slice(0, 5)) {
                  signalsSummary += `### ${signal.author} @ ${signal.company}\n`;
                  signalsSummary += `**Signal:** ${signal.signalType}\n`;
                  signalsSummary += `**Post:** ${signal.excerpt?.slice(0, 200)}...\n`;
                  signalsSummary += `**Suggested Action:** ${signal.suggestedComment?.slice(0, 150)}...\n`;
                  signalsSummary += `[View Post](${signal.postUrl})\n\n`;
                }
              }
            } catch (e) {
              signalsSummary = 'See feed-signals/daily folder for details.';
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸŽ¯ ${highIntent} High-Intent LinkedIn Signals - ${date}`,
              body: `## LinkedIn Feed Signals

            Found **${highIntent}** high-priority engagement opportunities today.

            ${signalsSummary}

            ### Action Items
            - [ ] Review each signal
            - [ ] Engage with high-priority posts
            - [ ] Track responses in pipeline

            ---
            ðŸ¤– Generated by LinkedIn Feed Monitor`,
              labels: ['linkedin', 'engagement', 'lead-gen']
            });
