name: Lead Gen Agent

on:
  # Run daily at 9 AM PST (5 PM UTC)
  schedule:
    - cron: '0 17 * * *'

  # Allow manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (scrape only, no post generation)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  issues: write

jobs:
  generate-posts:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout infra repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'scripts/lead-gen/package.json'

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Install dependencies
        working-directory: scripts/lead-gen
        run: npm install

      - name: Create output directories
        run: mkdir -p lead-gen/posts

      - name: Run Lead Gen Agent
        working-directory: scripts/lead-gen
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CONTENT_ROOT: ${{ github.workspace }}/content
          OUTPUT_ROOT: ${{ github.workspace }}
        run: |
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            node index.js --dry-run
          else
            node index.js
          fi

      - name: Check for new posts
        id: check_posts
        run: |
          if [ -d "lead-gen/posts" ] && [ "$(ls -A lead-gen/posts 2>/dev/null)" ]; then
            echo "has_posts=true" >> $GITHUB_OUTPUT
            echo "post_count=$(ls lead-gen/posts/*.md 2>/dev/null | wc -l)" >> $GITHUB_OUTPUT
          else
            echo "has_posts=false" >> $GITHUB_OUTPUT
            echo "post_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Commit generated posts
        if: steps.check_posts.outputs.has_posts == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Lead Gen Bot"
          git add lead-gen/
          git diff --staged --quiet || git commit -m "ğŸ¤– Lead gen posts for $(date +%Y-%m-%d)

          Generated ${{ steps.check_posts.outputs.post_count }} posts for review.

          ğŸ¤– Generated with Lead Gen Agent"
          git push

      - name: Create notification issue
        if: steps.check_posts.outputs.has_posts == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const postCount = '${{ steps.check_posts.outputs.post_count }}';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ“ Lead Gen Posts Ready for Review - ${date}`,
              body: `## New Posts Generated

            The Lead Gen Agent has generated **${postCount}** posts for your review.

            ### Location
            \`lead-gen/posts/\`

            ### Review Checklist
            - [ ] Review LinkedIn post
            - [ ] Review Twitter post
            - [ ] Review Reddit post
            - [ ] Edit as needed
            - [ ] Publish to platforms
            - [ ] Mark as posted in the files

            ### Quick Links
            - [View posts directory](../../tree/main/lead-gen/posts)

            ---
            ğŸ¤– Generated by Lead Gen Agent`,
              labels: ['lead-gen', 'content']
            });
