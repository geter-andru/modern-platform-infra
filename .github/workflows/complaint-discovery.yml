name: Complaint Discovery

on:
  # Run daily at 6 AM PST (2 PM UTC)
  schedule:
    - cron: '0 14 * * *'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      subreddits:
        description: 'Subreddits to scrape (comma-separated)'
        required: false
        default: 'Entrepreneur,SaaS,startups,sales'
        type: string

permissions:
  contents: write
  issues: write

jobs:
  discover-complaints:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout infra repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'scripts/complaint-discovery/package.json'

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Install dependencies
        working-directory: scripts/complaint-discovery
        run: npm install

      - name: Run Complaint Discovery
        working-directory: scripts/complaint-discovery
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          SUBREDDITS: ${{ github.event.inputs.subreddits || 'Entrepreneur,SaaS,startups,sales' }}
        run: node index.js

      - name: Create discovery issue
        uses: actions/github-script@v7
        env:
          RESULTS: ${{ env.DISCOVERY_RESULTS }}
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];

            // Read results from environment or use defaults
            const newComplaints = process.env.NEW_COMPLAINTS || '0';
            const highPain = process.env.HIGH_PAIN_COUNT || '0';

            if (parseInt(newComplaints) > 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `üîç ${newComplaints} New Complaints Discovered - ${date}`,
                body: `## Daily Complaint Discovery Report

            **New complaints found:** ${newComplaints}
            **High pain score (7+):** ${highPain}

            ### View Results
            Query the \`complaints\` table in Supabase:
            \`\`\`sql
            SELECT platform, category, pain_score, title, exact_phrases
            FROM complaints
            WHERE DATE(created_at) = '${date}'
            ORDER BY pain_score DESC;
            \`\`\`

            ### Action Items
            - [ ] Review high pain score complaints
            - [ ] Extract messaging language from exact_phrases
            - [ ] Add to content calendar

            ---
            ü§ñ Generated by Complaint Discovery Agent`,
                labels: ['complaint-discovery', 'lead-gen']
              });
            }
