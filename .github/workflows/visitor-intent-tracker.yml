name: Website Visitor Intent Tracker

on:
  # Run daily at 8 AM PST (4 PM UTC)
  schedule:
    - cron: '0 16 * * *'

  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  track-intent:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout infra repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'scripts/visitor-intent-tracker/package.json'

      - name: Install dependencies
        working-directory: scripts/visitor-intent-tracker
        run: npm install

      - name: Create output directories
        run: mkdir -p intent-signals/daily

      - name: Run Visitor Intent Tracker
        working-directory: scripts/visitor-intent-tracker
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OUTPUT_ROOT: ${{ github.workspace }}
        run: node index.js

      - name: Check for hot signals
        id: check_signals
        run: |
          if [ -d "intent-signals/daily" ] && [ "$(ls -A intent-signals/daily 2>/dev/null)" ]; then
            echo "has_signals=true" >> $GITHUB_OUTPUT
            # Count hot prospects
            hot=$(grep -l '"intentLevel":"hot"' intent-signals/daily/*.json 2>/dev/null | wc -l || echo "0")
            echo "hot_count=$hot" >> $GITHUB_OUTPUT
          else
            echo "has_signals=false" >> $GITHUB_OUTPUT
            echo "hot_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Commit signals
        if: steps.check_signals.outputs.has_signals == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Intent Tracker Bot"
          git add intent-signals/
          git diff --staged --quiet || git commit -m "ðŸ”¥ Visitor intent signals for $(date +%Y-%m-%d)

          ðŸ¤– Generated with Visitor Intent Tracker"
          git push

      - name: Create hot prospect issue
        if: steps.check_signals.outputs.hot_count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const date = new Date().toISOString().split('T')[0];

            let hotProspects = '';
            try {
              const signalsDir = 'intent-signals/daily';
              const files = fs.readdirSync(signalsDir).filter(f => f.startsWith(date));

              for (const file of files.slice(0, 1)) {
                const content = JSON.parse(fs.readFileSync(`${signalsDir}/${file}`, 'utf8'));
                const hot = content.visitors?.filter(v => v.intentLevel === 'hot') || [];

                for (const visitor of hot.slice(0, 10)) {
                  hotProspects += `### ${visitor.company || visitor.sessionId}\n`;
                  hotProspects += `- **Pages:** ${visitor.pagesViewed?.join(', ')}\n`;
                  hotProspects += `- **Time on Site:** ${visitor.totalTime}\n`;
                  hotProspects += `- **Last Visit:** ${visitor.lastVisit}\n`;
                  hotProspects += `- **Suggested Action:** ${visitor.suggestedAction}\n\n`;
                }
              }
            } catch (e) {
              hotProspects = 'See intent-signals/daily folder for details.';
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ”¥ Hot Prospect Alert - ${date}`,
              body: `## High-Intent Website Visitors

            The following visitors showed strong buying signals yesterday.

            ${hotProspects}

            ### Action Items
            - [ ] Review each visitor's journey
            - [ ] Send personalized outreach
            - [ ] Update pipeline status

            ---
            ðŸ¤– Generated by Visitor Intent Tracker`,
              labels: ['hot-prospect', 'lead-gen']
            });
